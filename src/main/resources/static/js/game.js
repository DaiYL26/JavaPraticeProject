let time=60;window.WebSocket||alert("您的浏览器不支持WebSocket！，无法使用该功能");const AttributeBinding={data:()=>({words:[],curIndex:0,userid:"",is_test:!1,is_matching:!1,is_ready:!1,is_commit:!1,is_begin:!0,opponent:{},selfScore:0,selfRank:0,isConfirm:!1,is_recognize:!1,speelWord:"",is_invaild:!1,testInfo:"请输入单词的拼写"}),methods:{next(e){this.curIndex+e>=0&&this.curIndex+e<this.words.length&&(this.curIndex+=e)},loadWords(){let e=this;$.post("/game/getGameWords",{gameId:e.gameId},function(t){if(200==t.code){let s=JSON.parse(t.data);for(let t=0;t<s.length;t++)try{let i=JSON.parse(s[t].json);e.words.push(i)}catch(e){}setTimeout(function(t){e.send("","READY")},1e3)}else 500==t.code&&alert(t.msg)})},onMatchSuccess(e){let t=e.split(";");this.gameId=t[1],this.is_matching=!1,this.is_ready=!0;let s=JSON.parse(t[0]);this.opponent.id=s.id,this.opponent.name=s.name,this.opponent.score=0,this.opponent.rankScore=s.score,this.loadWords()},init(){let e=this;this.socket.onopen=function(t){e.send("","START_MATCHING")},this.socket.onerror=function(t){alert("连接超时"),e.cancelMatching()},this.socket.onmessage=function(t){let s=JSON.parse(t.data);if("MATCH_SUCCESS"===s.type)e.opponentId=s.id,e.opponentName=s.name,e.onMatchSuccess(s.data);else if("START"===s.type)e.is_ready=!1,e.is_test=!0,e.timer=setInterval(function(){if(time>0){let e="对战剩余 "+--time+" 秒";$("#timeHodler").text(e)}},1e3);else if("COMMIT"===s.type){s.data.split(";");e.is_test=!1,e.is_commit=!0,clearInterval(e.timer)}else"CORRECT"===s.type?"true"===s.data?(e.words.splice(e.curIndex,1),e.selfScore++,bs4pop.notice("正确",{position:"topcenter",type:"success"})):"false"===s.data&&e.opponent.score++:"WRONG"===s.type?bs4pop.notice("拼写错误",{position:"topcenter",type:"warning"}):"CANCEL_MATCHING"===s.type&&(e.socket.close(),e.socket=null,e.is_matching=!1,e.is_begin=!0,""!==s.data&&alert(s.data))}},send(e,t){let s=this;if(this.socket&&this.socket.readyState==WebSocket.OPEN){let i={};if(i.id=parseInt(this.user.id),i.type=t,"START_MATCHING"===t)i.data=$.cookie("satoken");else if("ANSWER"===t){let t={};t.spelling=e,t.wordRank=s.curWord.wordRank,t.gameId=s.gameId,i.data=JSON.stringify(t)}this.socket.send(JSON.stringify(i))}},logout(){$.get("api/logout",function(e){1==e&&(localStorage.removeItem("user"),$(location).attr("href","/"))})},toGame(){$(location).attr("href","/game")},startMatching(){this.is_begin=!1,this.is_matching=!0,this.socket=new WebSocket("ws://120.77.222.189:8801/game"),this.init()},cancelMatching(){this.socket&&(this.send("","CANCEL_MATCHING"),this.socket.close(),this.socket=null),this.is_matching=!1,this.is_begin=!0},testConfirm(){if(!this.speelWord.trim())return void bs4pop.notice("请输入单词",{position:"topcenter",type:"warning"});let e=this.speelWord.trim();this.send(e,"ANSWER"),this.speelWord=""},playAudio(e){let t=$("#wordAudio")[0];1==e?(t.src=this.curSpeech.uk,t.load(),t.play()):2==e?(t.src=this.curSpeech.us,t.load(),t.play()):3==e&&(t.src="https://dict.youdao.com/dictvoice?word="+this.searchRes.word+"&type=1",t.load(),t.play())},beforeunloadHandler(e){if(this.is_matching)return this.cancelMatching(),(e=e||window.event)&&(e.returnValue="关闭提示"),"关闭提示"},load(){let e=this;$.post("/game/getStatus",{id:e.user.id},function(t){200==t.code&&(e.selfRank=t.data)})}},computed:{curWord(){return null===this.words?"":this.words[this.curIndex]},curSpeech(){let e=this.words[this.curIndex],t="https://dict.youdao.com/dictvoice?word=";return{uk:t+e.ukspeech,us:t+e.usspeech}}},created(){window.addEventListener("beforeunload",e=>this.beforeunloadHandler(e));let e=localStorage.getItem("user");this.user=JSON.parse(e),this.load()},destroyed(){window.removeEventListener("beforeunload",e=>this.beforeunloadHandler(e))}};Vue.createApp(AttributeBinding).mount("#app");let handler=setInterval(function(){$.get("api/isLogin",function(e){!0!==e.data&&(clearInterval(handler),alert("您的账号已经在别处登录！"),$(location).attr("href","/"))})},3e3);